<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout-registrant}">

<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css">
</th:block>

<!-- index.html 고유 스크립트 추가 -->
<th:block layout:fragment="script">

</th:block>

<div class="rightCnt" layout:fragment="content">
    <!-- title area -->
    <div class="titWrap">
        <h2 class="h2">상품 수정</h2>
        <div class="breadWrap">
            <ol class="breadcrumb">
                <li><a href="#">Home</a></li>
                <li><a href="#">등록 상품</a></li>
                <li class="active">상품 수정</li><!-- 마지막 li -->
            </ol>
        </div>
    </div>
    <!-- //title area -->

    <!-- content -->
    <div class="content">
        <form th:action="@{/softwares}" th:object="${software}" action="#" id="updateSoftwareForm" enctype="multipart/form-data">
        <!-- cBox1 -->
        <div class="cBox type1 appCnt-info">
            <div class="cBox-hd">
                <h4 class="c-tit">상품 수정하기</h4>
            </div>
            <div class="cBox-cnt pt20">
                <!-- inner -->
                <div class="in d_block">
                    <!-- table top -->
                    <div class="tb-top">
                        <div class="pull-right">
                            <span class="point2"><i class="i_star">필수입력</i> 는 필수입력 사항입니다.</span>
                        </div>
                    </div>
                    <!-- //table top -->
                    <!-- table -->
                    <div class="tbw type1">
                        <table class="table">
                            <colgroup>
                                <col style="width:15%;">
                                <col style="width:auto;">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th scope="row">상품명<i class="i_star">필수입력</i></th>
                                <td><input class="form-control" type="text" th:value="${software.name}" id="softwareName"></td>
                            </tr>
                            <tr>
                                <th scope="row">카테고리<i class="i_star">필수입력</i></th>
                                <td>
                                    <select id="softwareCategory">
                                        <option th:each="category : ${categories}"
                                                th:value="${category.id}"
                                                th:utext="${category.name}"
                                                th:selected="${category.id} == ${software.category.id}">
                                        </option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">개요<i class="i_star">필수입력</i></th>
                                <td><input class="form-control" style="height:50px;" type="text" th:value="${software.summary}" id="softwareSummary"></td>
                            </tr>


                            <tr>
                                <th scope="row">아이콘<i class="i_star">필수입력</i></th>
                                <td>
                                    <!-- 첨부파일 -->
                                    <div class="fileUploadWrap selected_ico" style="width:50%;">
                                        <input tabindex="-1" class="form-control" id="iconFileInput" name="iconFile" multiple style="position: absolute; clip: rect(0px 0px 0px 0px);" type="file" data-icon-name="fa fa-upload" data-button-text="" data-class-input="form-control" data-class-button="btn btn-default" filestyle="" onchange="getThumbnailPreview(this, $('#icon_image'))">
                                        <div class="bootstrap-filestyle input-group">
                                            <span tabindex="0" class="group-span-filestyle input-group-btn">
                                                 <label class="btn btn-default " for="iconFileInput" id="icon_image">
                                                    <img class="logo" alt="" th:src="${software.iconPath}" />
                                                    <span class="ico ico_fileupload">파일찾기</span>
                                                </label>
                                            </span>
                                            <div class="input-form-group">
                                                <input name="userfile" disabled="" class="form-control" id="userfile" type="text" placeholder="아이콘으로 등록할 이미지를 선택하세요.">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- //첨부파일 -->
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">스크린샷<i class="i_star">필수입력</i></th>
                                <td>
                                    <div class="screenShotBox">
                                        <div class="sshotWrap">
                                            <ul>
                                                <li name="li_in" id="li_in" th:each="screenshot : ${software.screenshotList}">
                                                    <div class="sshot_in">
                                                        <img th:src="${screenshot}" alt="" id="image_form_url"/>
                                                        <a href="" data-toggle="modal" data-target="#myModal_del"><span class="ico ico_delete" name="ico_delete">X</span></a>
                                                    </div>
                                                </li>
                                                <!-- //첨부파일 -->
                                                <li id="li_sshot">
                                                    <div class="fileUploadWrap selected_sshot">
                                                        <input tabindex="-1" class="form-control" id="screenshotFileInput" style="position: absolute; clip: rect(0px 0px 0px 0px);" type="file" name="screenshots" multiple="multiple" data-icon-name="fa fa-upload" data-button-text="" data-class-input="form-control" data-class-button="btn btn-default" filestyle="">
                                                        <div class="bootstrap-filestyle input-group">
                                                            <span tabindex="0" class="group-span-filestyle input-group-btn">
                                                                <label class="btn btn-default " for="screenshotFileInput" id="screenshot_image_list">
                                                                    <span class="ico ico_fileupload">파일찾기</span>
                                                                </label>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </li>
                                                <!-- //첨부파일 -->
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">상세설명</th>
                                <td>
                                    <div class="tbw_inner_txt">
                                        <input class="form-control" style="height:150px;" type="text" th:value="${software.description}" id="softwareDescription">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">파일유형</th>
                                <td>
                                    <div class="radio radio-inline" th:each="type : ${types}">
                                        <input name="softwareType" th:id="'radio1-' + ${type}" type="radio" th:field="*{type}" th:value="${type}" >
                                        <label class="label" th:for="'radio1-' + ${type}" th:text="${type}"></label>
                                    </div>
                                </td>
                            </tr>


                            <tr>
                                <th scope="row">상품파일<i class="i_star">필수입력</i></th>
                                <td>
                                    <!-- 첨부파일 -->
                                    <div class="fileUploadWrap" style="width:50%;">
                                        <input tabindex="-1" class="form-control" id="softwareAppFileInput" multiple style="position: absolute; clip: rect(0px 0px 0px 0px);" type="file" name="softwareAppFile" onchange="extractFileName(this, $('#softwareAppFile'))" data-icon-name="fa fa-upload" data-button-text="" data-class-input="form-control" data-class-button="btn btn-default" filestyle="">
                                        <div class="bootstrap-filestyle input-group">
                                            <input class="form-control" id="softwareAppFile" type="text" th:value="${software.app}">
                                            <span tabindex="0" class="group-span-filestyle input-group-btn">
                                                <label class="btn btn-default" for="softwareAppFileInput">
                                                    <span class="btn btn-md btn-color1">파일찾기</span>
                                                </label>
                                            </span>
                                        </div>
                                    </div>
                                    <!-- //첨부파일 -->
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">환경파일<i class="i_star">필수입력</i></th>
                                <td>
                                    <!-- 첨부파일 -->
                                    <div class="fileUploadWrap" style="width:50%;">
                                        <input tabindex="-1" class="form-control" id="softwareManifestInput" multiple style="position: absolute; clip: rect(0px 0px 0px 0px);" type="file" name="softwareManifest" onchange="extractFileName(this, $('#softwareManifest'))" data-icon-name="fa fa-upload" data-button-text="" data-class-input="form-control" data-class-button="btn btn-default" filestyle="">
                                        <div class="bootstrap-filestyle input-group">
                                            <input id="softwareManifest" class="form-control" type="text" th:value="${software.manifest}">
                                            <span tabindex="0" class="group-span-filestyle input-group-btn">
                                                <label class="btn btn-dfefault" for="softwareManifestInput">
                                                    <span class="btn btn-md btn-color1">파일찾기</span>
                                                </label>
                                            </span>
                                        </div>
                                    </div>
                                    <!-- //첨부파일 -->
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">판매가격<i class="i_star">필수입력</i></th>
                                <td>
                                    <div class="form-group">
                                        <input style="width:100px;" type="text" th:value="${software.pricePerDay}" id="softwarePricePerDay"> 원 / 월
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <th scope="row">전시여부<i class="i_star">필수입력</i></th>
                                <td>
                                    <div class="radio radio-inline" th:each="yn : ${yns}">
                                        <input name="softwareInUse" th:id="'radio1-' + ${yn}" type="radio" th:value="${yn}" th:checked="${software.inUse} == ${yn}">
                                        <label class="label" th:for="'radio1-' + ${yn}" th:text="${yn}"></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">버전</th>
                                <td><input class="form-control" style="width:100px;" type="text" th:value="${software.version}" id="softwareVersion" readonly></td>
                            </tr>
                            <tr>
                                <th scope="row">등록일자</th>
                                <td><input class="form-control" type="text" th:value="${software.createdDate}" id="softwareCreatedDate" readonly></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- //table -->

                </div>
                <!-- //inner -->
            </div>
        </div>
        <!-- //cBox1 -->
        <div class="cont_btnBox">
            <div class="pull-right">
                <button name="button" class="btn btn-color1 btn-md" type="button" data-toggle="modal" data-target="#myModal_ok">저장</button>
                <!-- Modal -->
                <div class="modal fade" id="myModal_ok" tabindex="-1" role="dialog" aria-labelledby="modalLabel_update" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content modal-sm"><!-- 개발에서 사용하는 다른 팝업모듈 사용시 이부분만 사용하세요.  -->
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="modalLabel_update">상품 수정</h4>
                            </div>
                            <div class="modal-body">
                                <div class="only-text">
                                    상품을 수정하시겠습니까?
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" name="button" class="btn btn-color1"  th:onclick="'javascript:saveBtn(\''+ ${software.id} +'\');'">확인</button>
                                <button type="button" name="button" class="btn btn-color2" data-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- //Modal -->
                <button name="button" class="btn btn-color7 btn-md" type="button" data-toggle="modal" data-target="#myModal_cancel">취소</button>
                <!-- Modal -->
                <div class="modal fade" id="myModal_cancel" tabindex="-1" role="dialog" aria-labelledby="modalLabel_cancel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content modal-sm"><!-- 개발에서 사용하는 다른 팝업모듈 사용시 이부분만 사용하세요.  -->
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                                <h4 class="modal-title" id="modalLabel_cancel">수정 취소</h4>
                            </div>
                            <div class="modal-body">
                                <div class="only-text">
                                    취소 하시겠습니까?
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" name="button" class="btn btn-color1"  th:onclick="'location.href = \'' + @{/softwares/{id}(id=${software.id})} + '\''">확인</button>
                                <button type="button" name="button" class="btn btn-color2" data-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal -->
            </div>
        </div>
        </form>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal_del" tabindex="-1" role="dialog" aria-labelledby="modalLabel_del" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content modal-sm"><!-- 개발에서 사용하는 다른 팝업모듈 사용시 이부분만 사용하세요.  -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="modalLabel_del">스크린 샷 삭제</h4>
                </div>
                <div class="modal-body">
                    <div class="only-text">
                        삭제 하시겠습니까?
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" name="button" id="deleteSoftwareBtn" class="btn btn-color1" onclick="deleteSoftwareBtn()" data-dismiss="modal">확인</button>
                    <button type="button" name="button" class="btn btn-color2" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->

    <!-- //content -->
    <script th:inline="javascript" type="text/javascript">
        /*<![CDATA[*/

        $(document).ready(function() {
            console.log("software-update init");
        });

        // save
        var saveBtn = function(id) {
            console.log("ID : " + id);
            modifySoftware(id);
        };

        var modifySoftware = function (id) {
            //상품명
            var softwareName = $("#softwareName").val();
            //카테고리
            var softwareCategory = $("#softwareCategory option:selected").val();
            //개요&간단설명
            var softwareSummary = $("#softwareSummary").val();
            //아이콘
            var iconFileInput = $("#iconFileInput").val();
            //스크린샷
            var screenshotFileInput = $("#screenshotFileInput").val();
            //상세설명
            var softwareDescription = $("#softwareDescription").val();
            //파일유형
            var softwareType  = $('input:radio[name="softwareType"]:checked').val();
            //상품파일
            var softwareAppFile = $("#softwareAppFile").val();
            //환경파일
            var softwareManifest  = $("#softwareManifest").val();
            //판매가격
            var softwarePricePerDay = $("#softwarePricePerDay").val();
            //전시여부
            var softwareInUse  = $('input:radio[name="softwareInUse"]:checked').val();
            //버전
            var softwareVersion = $("#softwareVersion").val();
            //상태
            var softwareStatus =  $('input:radio[name="softwareStatus"]:checked').val();
            //반려사유
            var softwareConfirmComment = $("#softwareConfirmComment").val();
            //등록일자
            var softwareCreatedDate = $("#softwareCreatedDate").val();
            //처리일자
            var softwareStatusModifiedDate = $("#softwareStatusModifiedDate").val();


            if(softwareConfirmComment === null || softwareConfirmComment === '') {
                softwareConfirmComment = '';
            }

            var reqParam = {
                "inUse" : softwareInUse,
                "id" : id,
                "name" : softwareName,
                "category" : {
                "id" : softwareCategory
            },
                "app" : softwareAppFile,
                "manifest" : softwareManifest,
                "icon" : iconFileInput,
                "screenshotList" : [screenshotFileInput],
                "summary" : softwareSummary,
                "description" : softwareDescription,
                "type" : softwareType,
                "pricePerDay" : softwarePricePerDay,
                "version" : softwareVersion
            }

            var reqUrl = "/softwares/" + id;

            //console.log
            console.log("iconFile" + iconFileInput);
            console.log(JSON.stringify(reqParam));
            console.log("REST_URL: " + reqUrl);

            procCallAjax(reqUrl, "PUT", JSON.stringify(reqParam), null, callbackModifySoftware);
        };

        var callbackModifySoftware = function (data) {
            console.log("data: " + data);
            procMovePage("/softwares/{id}".replace("{id}", data.id));

        };

        //icon
        var getThumbnailPreview = function (html, $target) {
            if (html.files && html.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $target.css('display', '');
                    $target.html('<img src="' + e.target.result + '" border="0" alt="" />');
                };
                reader.readAsDataURL(html.files[0]);
            }
        };

        //Screenshot
        var getThumbnailPreviewScreenshot = function (html, $target, countNum) {
            if (html.files && html.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $target.css('display', '');
                    $target.html('<div class="sshot_in">'
                        + '<img class="btn btn-default" src="' + e.target.result + '" alt="" id="image_form_url" border="0">'
                        + '<a href="" data-toggle="modal" data-target="#myModal_del"><span class="ico ico_delete" name="ico_delete">X</span></a>'
                        + '</div>')
                };
                reader.readAsDataURL(html.files[0]);

                console.log(countNum);
                count = countNum + 1;
                console.log(count);

            }
        };

        // [Common] extractFileName
        var extractFileName = function(html, $target) {
            var val = $(html).val().split("\\");
            var f_name = val[val.length-1]; //마지막 화일명
            var s_name = f_name.substring(f_name.length-4, f_name.length);

            $target.val(f_name);
        };

        //delete Software ScreenshotBtn
        function deleteSoftwareBtn() {
            $("#li_in").hide();
            $("#image_form_url").attr("src", "");
        }


        // RESET APP SAMPLE
        var resetAppSample = function (strHtml) {
            $('#devEnvApp').filestyle('clear');
            var target = $('#li_sshot');
            target.html(strHtml);
        };


        // 앱 샘플 파일 선택 변경시 파일정보 영역 갱신
        $("#screenshotFileInput").on("change", function (e) {
            //setAppSample($(this));
            procSetFileInfo($(this)[0].files);
        });


        // SET FILE INFO
        var procSetFileInfo = function(reqFile) {
            var fileName = reqFile[0].name;
            //REQUEST_APP_SAMPLE_FILE = reqFile;
            procSetFileLabel(fileName, null);
        };


        // SET FILE LABEL
        var procSetFileLabel = function(reqFileName, reqFilePath) {
            if (null == reqFileName){
                return false;
            }

            var linkHtml;
            if ( reqFilePath != null ) {
                linkHtml = '<div class="fileUploadWrap selected_sshot">'
                    + '<input tabindex="-1" class="form-control" id="screenshotFileInput" style="position: absolute; clip: rect(0px 0px 0px 0px);" type="file" name="screenshots" multiple="multiple" data-icon-name="fa fa-upload" data-button-text="" data-class-input="form-control" data-class-button="btn btn-default" filestyle="" onchange="getThumbnailPreviewScreenshot(this, $(' + "\'" + pointLabelId + "')" + ', ' + count + ')>"'
                    + '<div class="bootstrap-filestyle input-group"><span tabindex="0" class="group-span-filestyle input-group-btn">'
                    + '<label class="btn btn-default " for="screenshotFileInput" id=' + labelId + '>'
                    + '<span class="ico ico_fileupload">파일찾기'
                    + '</span>'
                    + '</label>'
                    + '</span>'
                    + '</div>';
            }

            $('#li_sshot').html(linkHtml);

            // 앱 샘플 삭제 버튼 처리
            $('#li_in').on('click', function(e){
                $("#image_form_url").attr("src", "");
            });
        };


        /*]]>*/
    </script>
</div>
</html>
